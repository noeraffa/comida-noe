<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Comidas - Noe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --accent: #f59e0b; --bg: #fffbeb; --dark: #451a03; --danger: #ef4444; --healthy: #10b981; --link: #3b82f6; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--dark); }
        .container { max-width: 500px; margin: auto; }
        
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #fde68a; }
        input, select, button, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid #fde68a; font-size: 16px; box-sizing: border-box; }
        textarea { height: 100px; font-family: inherit; }
        
        .btn-add { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* Estilos de los Filtros */
        .filter-group { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .btn-filter { background: white; border: 1px solid var(--accent); color: var(--accent); padding: 6px 10px; border-radius: 10px; font-size: 0.75rem; cursor: pointer; flex: 1; min-width: 80px; }
        .btn-filter.active { background: var(--accent); color: white; }

        .comida-card { background: white; padding: 15px; border-radius: 15px; border-bottom: 4px solid #fde68a; margin-top: 12px; position: relative; }
        .sana-tag { position: absolute; top: -10px; right: 10px; background: var(--healthy); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        
        .actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; border-top: 1px solid #fff7ed; padding-top: 10px; }
        .btn-small { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; background: #fffcf0; border: 1px solid #fde68a; color: #b45309; font-weight: 600; cursor: pointer; }
        
        /* Modal */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; }
        
        .sticky-search { position: sticky; top: 10px; z-index: 100; border: 2px solid var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div class="card sticky-search">
        <h3>üîç Buscador</h3>
        <input type="text" id="buscador" placeholder="Ingrediente o nombre..." onkeyup="filtrar()">
        
        <div class="filter-group">
            <button class="btn-filter" id="f-comidas" onclick="setCategoria('principales')">üçΩÔ∏è Almuerzo/Cena</button>
            <button class="btn-filter" id="f-desayuno" onclick="setCategoria('Desayuno')">‚òï Desayuno</button>
            <button class="btn-filter" id="f-merienda" onclick="setCategoria('Merienda')">üç∞ Merienda</button>
            <button class="btn-filter" id="f-sana" onclick="setCategoria('sana')">ü•ó Sanas</button>
        </div>
    </div>

    <div id="lista"></div>

    <div class="card">
        <h3>‚ûï Nueva Comida</h3>
        <input type="text" id="new_comida" placeholder="Nombre de la comida">
        <input type="text" id="new_ing1" placeholder="Ingrediente 1">
        <input type="text" id="new_ing2" placeholder="Ingrediente 2">
        <input type="text" id="new_ing3" placeholder="Ingrediente 3">
        <input type="url" id="new_link" placeholder="Link receta (Opcional)">
        <textarea id="new_receta" placeholder="Escribe los pasos aqu√≠..."></textarea>
        <select id="new_momento">
            <option value="">¬øMomento ideal?</option>
            <option value="Almuerzo">Almuerzo</option>
            <option value="Cena">Cena</option>
            <option value="Desayuno">Desayuno</option>
            <option value="Merienda">Merienda</option>
        </select>
        <label style="display: flex; align-items: center; gap: 10px; color: var(--healthy); font-weight: bold;">
            <input type="checkbox" id="new_sana" style="width: auto;"> ü•ó Es comida sana
        </label>
        <button class="btn-add" onclick="agregarComida()">Guardar Plato</button>
    </div>
</div>

<div id="modal" onclick="cerrarModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="modal-titulo" style="margin-top: 0;"></h2>
        <div id="modal-cuerpo" style="white-space: pre-wrap; color: #555;"></div>
        <div id="modal-link" style="margin-top: 20px;"></div>
        <button onclick="cerrarModal()" style="margin-top: 20px; background: #eee; border: none;">Cerrar</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://onvfpmvlhzrxwwrcosib.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_QTdDzXiUIS_LUD_YkvRZ_g_arVSPr4X';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let comidas = [];
    let categoriaActual = 'nada';

    async function cargar() {
        const { data, error } = await _supabase.from('comidas').select('*').order('Comida', { ascending: true });
        if (!error) comidas = data;
        actualizarVista();
    }

    function setCategoria(cat) {
        // Si tocamos el mismo bot√≥n, se desactiva
        categoriaActual = (categoriaActual === cat) ? 'nada' : cat;
        
        // Actualizar botones visualmente
        document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));
        if (categoriaActual !== 'nada') {
            const btnId = cat === 'principales' ? 'f-comidas' : cat === 'sana' ? 'f-sana' : `f-${cat.toLowerCase()}`;
            document.getElementById(btnId).classList.add('active');
        }
        actualizarVista();
    }

    function filtrar() {
        actualizarVista();
    }

    function actualizarVista() {
        const busqueda = document.getElementById('buscador').value.toLowerCase().trim();
        const listaDiv = document.getElementById('lista');

        // REGLA: Si no hay texto Y no hay categor√≠a seleccionada, pantalla limpia
        if (busqueda === "" && categoriaActual === 'nada') {
            listaDiv.innerHTML = '<p style="text-align:center; color:#999; margin-top:30px;">Escribe algo o eleg√≠ una categor√≠a...</p>';
            return;
        }

        let filtradas = comidas.filter(c => {
            const m = (c["momento_ideal"] || c["Categor√≠a"] || "").toLowerCase();
            const nombreEIng = `${c["Comida"]} ${c["Ingrediente 1"]} ${c["Ingrediente 2"]}`.toLowerCase();
            
            // Filtro por texto
            const cumpleBusqueda = busqueda === "" || nombreEIng.includes(busqueda);
            
            // Filtro por categor√≠a
            let cumpleCat = true;
            if (categoriaActual === 'principales') {
                cumpleCat = (m.includes('almuerzo') || m.includes('cena'));
            } else if (categoriaActual === 'sana') {
                cumpleCat = c.es_sana;
            } else if (categoriaActual !== 'nada') {
                cumpleCat = m.includes(categoriaActual.toLowerCase());
            }

            return cumpleBusqueda && cumpleCat;
        });

        renderizar(filtradas);
    }

    function renderizar(lista) {
        const listaDiv = document.getElementById('lista');
        listaDiv.innerHTML = lista.length === 0 ? '<p style="text-align:center;">No hay resultados.</p>' : '';
        
        lista.forEach(c => {
            const tieneDato = c.link_receta || c.receta_escrita;
            listaDiv.innerHTML += `
                <div class="comida-card">
                    ${c.es_sana ? '<span class="sana-tag">ü•ó SANA</span>' : ''}
                    <strong>${c["Comida"]}</strong>
                    <div class="ingredientes">${[c["Ingrediente 1"], c["Ingrediente 2"]].filter(i => i).join(' ‚Ä¢ ')}</div>
                    <div class="actions">
                        ${tieneDato ? `<button class="btn-small" style="background:#e0f2fe; color:#0369a1" onclick="verReceta(${c.id})">üìñ Receta</button>` : ''}
                        <button class="btn-small" onclick="toggleSana(${c.id}, ${c.es_sana})">ü•ó</button>
                        <button class="btn-small" style="color:red" onclick="eliminarComida(${c.id})">üóëÔ∏è</button>
                    </div>
                </div>`;
        });
    }

    // --- Funciones de Soporte (Iguales a las tuyas) ---
    function verReceta(id) {
        const c = comidas.find(item => item.id === id);
        document.getElementById('modal-titulo').innerText = c["Comida"];
        document.getElementById('modal-cuerpo').innerText = c.receta_escrita || "Sin instrucciones.";
        document.getElementById('modal-link').innerHTML = c.link_receta ? `<a href="${c.link_receta}" target="_blank">üîó Link externo</a>` : '';
        document.getElementById('modal').style.display = 'flex';
    }

    function cerrarModal() { document.getElementById('modal').style.display = 'none'; }

    async function agregarComida() {
        const nombre = document.getElementById('new_comida').value;
        if (!nombre) return alert("Nombre obligatorio");
        await _supabase.from('comidas').insert([{
            "Comida": nombre,
            "Ingrediente 1": document.getElementById('new_ing1').value,
            "Ingrediente 2": document.getElementById('new_ing2').value,
            "Ingrediente 3": document.getElementById('new_ing3').value,
            "link_receta": document.getElementById('new_link').value,
            "receta_escrita": document.getElementById('new_receta').value,
            "momento_ideal": document.getElementById('new_momento').value,
            "es_sana": document.getElementById('new_sana').checked
        }]);
        location.reload();
    }

    async function toggleSana(id, estado) {
        await _supabase.from('comidas').update({ es_sana: !estado }).eq('id', id);
        cargar();
    }

    async function eliminarComida(id) {
        if (confirm("¬øBorrar?")) { await _supabase.from('comidas').delete().eq('id', id); cargar(); }
    }

    cargar();
</script>
</body>
</html>
